const fs = require('fs')
const path = require('path')
const Template = require("../template");

const stub = `
# This file was autogenerated at {{generatedAt}}.
FROM {{image}}:{{tag}}
MAINTAINER {{maintainer}}

LABEL {{labels}}
ENV {{environemntVariables}}

WORKDIR /app
COPY . /app

RUN {{dependencyCommand}}

ENTRYPOINT ["{{entrypoint}}"]
CMD ["{{command}}"]
`;

module.exports = (params, writeFile = true) => {
  const {
    image,
    tag,
    maintainer,
    labels = [ `builtAt=${new Date().toISOString().substring(0, 10)}` ],
    environemntVariables = [ 'TZ=GMT' ],
    generatedAt = new Date().toISOString(),
    dependencyCommand,
    entrypoint,
    command,
  } = params;

  const template = new Template({ stub });

  const content = template.render({
    generatedAt,
    image,
    tag,
    maintainer,
    labels: [].concat(labels).join(' '),
    environemntVariables,
    dependencyCommand,
    entrypoint,
    command,
  })

  if (writeFile) {
    fs.writeFileSync(path.join(process.cwd(), 'dockerfile'), content)
  }

  return content
}
