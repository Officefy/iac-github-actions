const fs = require('fs')
const path = require('path')
const Template = require("../template");

const stub = `
# This file was autogenerated at {{generatedAt}}.
FROM {{image}}:{{tag}}

LABEL {{labels}}

ENV {{environmentVariables}}

WORKDIR /app
COPY . /app

RUN {{dependencyCommand}}

ENTRYPOINT {{entrypoint}}
CMD {{command}}
`;

module.exports = function (params, writeFile = true) {
  console.log({ params })

  let {
    image,
    tag,
    labels = [],
    environmentVariables = [ 'TZ=GMT', 'ENV=development' ],
    generatedAt = new Date().toISOString(),
    dependencyCommand,
    entrypoint,
    command,
  } = params;

  labels = [
    `built-at=${new Date().toISOString().substring(0, 10)}`,
  ].concat(labels).join(' \\\n\t')

  command = JSON.parse(command)
  entrypoint = JSON.parse(entrypoint)
  dependencyCommand = JSON.parse(dependencyCommand)

  const template = new Template({ stub });

  const content = template.render({
    generatedAt,
    image,
    tag,
    labels,
    environmentVariables: [].concat(environmentVariables).join(' \\\n\t'),
    dependencyCommand: [].concat(dependencyCommand).join(' \\\n\t&& '),
    entrypoint: `["${[].concat(entrypoint).join('", "')}"]`,
    command: `["${[].concat(command).join('", "')}"]`,
  })

  console.log(content)
  
  if (writeFile) {
    fs.writeFileSync(path.join(process.cwd(), 'Dockerfile'), content)
  }

  return content
}
